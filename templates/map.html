{% extends "base.html" %}
{% block title %}Live Map{% endblock %}

{% block content %}
<h2>Live GPS Route</h2>

<div style="margin-bottom: 1rem;">
  <button onclick="saveRoute()">💾 Save Route</button>
  <select id="savedRoutes" onchange="loadRoute()">
    <option value="">📁 Load Saved Route</option>
  </select>
  <button onclick="deleteRoute()">🗑️ Delete Route</button>

  <select id="playSelect" style="margin-left: 0.5rem;">
    <option value="live">▶️ Play Live Route</option>
    <option value="saved">▶️ Play Saved Route</option>
  </select>
  <button onclick="playRoute()">▶️ Play</button>

  <button onclick="clearRoute()">🧹 Clear Map</button>
</div>

<div style="margin-bottom: 1rem;">
  <button id="toggleAuto" onclick="toggleAutoUpdate()">Auto-Update: ON</button>
  <button id="manualRefresh" onclick="fetchLiveRoute()" style="display:none;">🔄 Refresh Now</button>
  <label for="loggingToggle">Enable Logging:</label>
  <input type="checkbox" id="loggingToggle" checked> <!-- Default to checked (logging enabled) -->
</div>

<!-- MAC Label -->
<div id="mac-label" style="
  position: absolute;
  top: 12px;
  right: 20px;
  background-color: rgba(31, 31, 31, 0.9);
  color: #80ffd3;
  padding: 6px 12px;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  border: 1px solid #80ffd3;
  border-radius: 4px;
  z-index: 999;
  display: none;">
  MAC: <span id="mac-value">N/A</span>
</div>

<!-- Map container -->
<div id="map" style="height: 80vh;"></div>

<!-- Analysis tools widget (separate from map) -->
<div id="analysis-widget">
  <h4>🧮 Analysis</h4>
  <button onclick="showElevation()">Elevation Profile</button>
  <button onclick="showSpeedGraph()">Speed Graph</button>
  <button onclick="toggleHeatmap()">Toggle Heatmap</button>
  <button onclick="detectIdleStops()">Detect Idle</button>
  <button onclick="colorBySpeed()">Color by Speed</button>
</div>

<!-- Leaflet JS + CSS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block script_extra %}
<script>
let map = L.map('map').setView([37.5, 22.37], 16);
let routeLine = null;
let liveCoords = [];
let animMarker = null;
let startMarker = null;
let endMarker = null;

let autoUpdate = true;
let intervalId = null;
let heatLayer = null;

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let macAddress = '08:3A:8D:DE:E5:10';  // Default MAC address for testing, replace with actual MAC when available

let previousCoords = null;  // Initialize the previous coordinates globally

function fetchLiveRoute(mac) {
  if (!mac || mac.trim() === '') {
    console.log("Error: MAC address is missing!");
    return;  // Exit if MAC address is missing or empty
  }

  console.log("Function: fetchLiveRoute() called");

  let url = `/api/coords?mac=${mac}`;

  console.log(`Requesting URL: ${url}`);

  fetch(url)
    .then(res => res.json())
    .then(data => {
      console.log("Response data:", data);
      if (!Array.isArray(data) || data.length === 0) {
        console.log("No coordinates found for this MAC address.");
        return;  // Exit if no data or invalid data is returned
      }

      // Check if the coordinates have changed
      const latestCoords = data[data.length - 1];
      const { lat, lng, timestamp } = latestCoords;
      console.log(`Latest coordinates: lat=${lat}, lng=${lng}, timestamp=${timestamp}`);

      if (previousCoords && previousCoords.lat === lat && previousCoords.lng === lng) {
        console.log("Received the same coordinates as the previous one. Skipping update.");
        return;  // Exit if the coordinates haven't changed
      }

      // Update the previous coordinates to the latest one
      previousCoords = { lat, lng };

      // Draw route if coordinates are found
      liveCoords = data.map(p => [p.lat, p.lng]);

      // Optionally, display timestamps or other data for debugging or rendering purposes
      data.forEach(coord => {
        console.log(`Coordinate at ${coord.timestamp}: lat=${coord.lat}, lng=${coord.lng}`);
      });

      drawRoute(liveCoords, 'blue');

      // Update the MAC label
      document.getElementById('mac-value').textContent = mac;
      document.getElementById('mac-label').style.display = 'block';

      // Send latest coordinates data
      sendGpsData(lat, lng, mac);
    })
    .catch(err => {
      console.log("Error fetching data:", err);
    });
}

function toggleAutoUpdate() {
  autoUpdate = !autoUpdate;
  const toggleBtn = document.getElementById('toggleAuto');
  const refreshBtn = document.getElementById('manualRefresh');

  if (autoUpdate) {
    toggleBtn.textContent = "Auto-Update: ON";
    refreshBtn.style.display = "none";
    if (macAddress) {  // Ensure valid MAC address is present before starting the interval
      intervalId = setInterval(() => fetchLiveRoute(macAddress), 5000);
    } else {
      console.log("Error: No MAC address available for auto-update");
    }
  } else {
    toggleBtn.textContent = "Auto-Update: OFF";
    refreshBtn.style.display = "inline-block";
    clearInterval(intervalId);
  }
}

// Call fetchLiveRoute only if MAC address is valid
if (macAddress) {
  fetchLiveRoute(macAddress);  // Initially fetch live route with valid MAC
} else {
  console.log("Error: No MAC address to fetch data");
}

intervalId = setInterval(() => {
  if (macAddress) {  // Check for a valid MAC address before making the request
    fetchLiveRoute(macAddress);
  }
}, 5000);

// Retry function in case of failure
function retryFetch(mac) {
  let retries = 3;
  let attempt = 0;

  const retryInterval = setInterval(() => {
    if (attempt >= retries) {
      console.log("Max retry attempts reached.");
      clearInterval(retryInterval);  // Stop retries after max attempts
      return;
    }
    attempt++;
    console.log(`Retrying fetch... Attempt ${attempt}`);
    fetchLiveRoute(mac);  // Attempt to fetch again
  }, 5000);  // Retry every 5 seconds
}

// Function to draw the route on the map
function drawRoute(coords, color) {
  console.log("Function: drawRoute() called with coords:", coords);  // Debugging entry point
  if (routeLine) map.removeLayer(routeLine);
  if (startMarker) map.removeLayer(startMarker);
  if (endMarker) map.removeLayer(endMarker);

  routeLine = L.polyline(coords, { color: color || 'blue' }).addTo(map);
  startMarker = L.marker(coords[0], { title: 'Start' }).addTo(map).bindPopup('🚩 Start');
  endMarker = L.marker(coords[coords.length - 1], { title: 'End' }).addTo(map).bindPopup('🏁 End');
  map.fitBounds(routeLine.getBounds());
}

// Toggle auto-update for the live route
function toggleAutoUpdate() {
  autoUpdate = !autoUpdate;
  const toggleBtn = document.getElementById('toggleAuto');
  const refreshBtn = document.getElementById('manualRefresh');

  console.log("Function: toggleAutoUpdate() called");  // Debugging entry point

  if (autoUpdate) {
    toggleBtn.textContent = "Auto-Update: ON";
    refreshBtn.style.display = "none";
    intervalId = setInterval(fetchLiveRoute, 5000);
  } else {
    toggleBtn.textContent = "Auto-Update: OFF";
    refreshBtn.style.display = "inline-block";
    clearInterval(intervalId);
  }
}

// Save current route
function saveRoute() {
  console.log("Function: saveRoute() called");  // Debugging entry point
  if (!liveCoords.length) return alert("Nothing to save.");
  const name = prompt("Enter name to save this route:");
  if (!name.match(/^[a-zA-Z0-9_-]+$/)) return alert("Invalid name!");
  fetch('/routes/save', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: name, coords: liveCoords.map(c => ({ lat: c[0], lng: c[1] })) })
  }).then(() => {
    alert("Route saved!");
    fetchSavedRoutes();
  });
}

// Load saved route
function loadRoute() {
  console.log("Function: loadRoute() called");  // Debugging entry point
  const name = document.getElementById('savedRoutes').value;
  if (!name) return;
  fetch(`/routes/load/${name}`)
    .then(res => res.json())
    .then(data => {
      const loaded = data.map(p => [p.lat, p.lng]);
      drawRoute(loaded, 'green');
    });
}

// Delete saved route
function deleteRoute() {
  console.log("Function: deleteRoute() called");  // Debugging entry point
  const name = document.getElementById('savedRoutes').value;
  if (!name) return;
  if (!confirm(`Delete route "${name}"?`)) return;
  fetch(`/routes/delete/${name}`, { method: 'DELETE' })
    .then(() => {
      alert("Route deleted!");
      fetchSavedRoutes();
    });
}

// Play route (live or saved)
function playRoute() {
  console.log("Function: playRoute() called");  // Debugging entry point
  const source = document.getElementById('playSelect').value;

  if (animMarker) map.removeLayer(animMarker);

  if (source === 'live') {
    if (!liveCoords.length) {
      alert("No live route data available.");
      return;
    }
    animateRoute(liveCoords);
  } else {
    const name = document.getElementById('savedRoutes').value;
    if (!name) return alert("Select a saved route to play.");
    fetch(`/routes/load/${name}`)
      .then(res => res.json())
      .then(data => {
        const coords = data.map(p => [p.lat, p.lng]);
        animateRoute(coords);
      });
  }
}

// Animate route on the map
function animateRoute(coords) {
  console.log("Function: animateRoute() called");  // Debugging entry point
  if (!coords.length) return;
  let i = 0;
  animMarker = L.marker(coords[0]).addTo(map);
  const interval = setInterval(() => {
    if (i >= coords.length) return clearInterval(interval);
    animMarker.setLatLng(coords[i++]);
  }, 300);
}

// Clear all routes and markers from the map
function clearRoute() {
  console.log("Function: clearRoute() called");  // Debugging entry point
  if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
  if (animMarker) { map.removeLayer(animMarker); animMarker = null; }
  if (startMarker) { map.removeLayer(startMarker); startMarker = null; }
  if (endMarker) { map.removeLayer(endMarker); endMarker = null; }
}

// Fetch saved routes from the server
function fetchSavedRoutes() {
  console.log("Function: fetchSavedRoutes() called");  // Debugging entry point
  fetch('/routes')
    .then(res => res.json())
    .then(routes => {
      const dropdown = document.getElementById('savedRoutes');
      dropdown.innerHTML = '<option value="">📁 Load Saved Route</option>';
      routes.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        dropdown.appendChild(opt);
      });
    });
}

// Function to send GPS data to the server via POST
function sendGpsData(lat, lng, mac) {
  console.log(`Function: sendGpsData() called with lat: ${lat}, lng: ${lng}, mac: ${mac}`);  // Debugging entry point

  // Get the value of the logging toggle checkbox
  const loggingEnabled = document.getElementById("loggingToggle").checked;  // true if checked, false if unchecked

  // Prepare the JSON payload
  const jsonPayload = {
    latitude: lat,
    longitude: lng,
    mac: mac,
    logging_enabled: loggingEnabled  // Include the logging flag in the request payload
  };

  // Log the payload before sending
  console.log(`Sending data: ${JSON.stringify(jsonPayload)}`);

  // Use fetch to send the data as JSON
  fetch('/gps', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'  // Set content type to JSON
    },
    body: JSON.stringify(jsonPayload)  // Convert the object to JSON
  })
  .then(response => response.json())  // Expect a JSON response from the server
  .then(data => {
    console.log("Data sent successfully:", data);  // Log the server response
  })
  .catch(error => {
    console.error("Error sending GPS data:", error);  // Log any errors
  });
}

// Show speed graph
function showSpeedGraph() {
  console.log("Function: showSpeedGraph() called");  // Debugging entry point
  if (!liveCoords.length) return alert("No data to analyze speed.");
  const speeds = [];
  for (let i = 1; i < liveCoords.length; i++) {
    const [lat1, lng1] = liveCoords[i - 1];
    const [lat2, lng2] = liveCoords[i];
    const dist = map.distance([lat1, lng1], [lat2, lng2]);
    speeds.push((dist / 5).toFixed(2)); // rough speed estimate assuming 5s interval
  }
  const ctx = document.createElement('canvas');
  document.body.appendChild(ctx);
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: speeds.map((_, i) => i + 1),
      datasets: [{ label: 'Speed (m/s)', data: speeds, borderColor: 'red', fill: false }]
    }
  });
}

<!--intervalId = setInterval(() => fetchLiveRoute('08:3A:3A:8D:DE:E5:10'), 5000);  // Example mac address-->
fetchSavedRoutes();
</script>
{% endblock %}
